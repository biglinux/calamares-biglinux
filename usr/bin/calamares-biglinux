#!/bin/bash


if [ ! -f "/etc/calamares/biglinux" ]; then

# Simplify welcome

echo '---
showSupportUrl:         false
showKnownIssuesUrl:     false
showReleaseNotesUrl:    false

requirements:
    requiredStorage:    10
    requiredRam:        1.0
    check:
        - storage
        - ram
        - power
        - internet
        - root
    required:
        - storage
        - ram
        - root' > /etc/calamares/modules/welcome.conf
        


# Force btrfs compression using zstd
sed -i 's|subvol=@", partition.get("options", ""|subvol=@", partition.get("options", "compress-force=zstd"|g' /usr/lib/calamares/modules/mount/main.py
sed -i 's|subvol=@home", partition.get("options", ""|subvol=@home", partition.get("options", "compress-force=zstd"|g' /usr/lib/calamares/modules/mount/main.py
sed -i 's|autodefrag|autodefrag,compress-force=zstd:1|g;s|compress=lzo|ssd|g' /usr/share/calamares/modules/fstab.conf

# Use btrfs for default
sed -i 's|defaultFileSystemType.*"ext4"|defaultFileSystemType:  "btrfs"|g' /usr/share/calamares/modules/partition.conf


# Remove root password
echo '---
defaultGroups:
    - lp
    - network
    - power
    - sys
    - wheel
    - vboxsf
autologinGroup:  autologin
doAutologin:     false
sudoersGroup:    wheel
setRootPassword: false
doReusePassword: true
availableShells: /bin/bash, /bin/zsh
avatarFilePath:  ~/.face' > /etc/calamares/modules/users.conf


# General configuration
echo '---
modules-search: [ local ]

sequence:
    - show:
        - welcome
        - locale
        - keyboard
        - partition
        - users
        - summary
    - exec:
        - partition
        - mount
        - btrfs
        - unpackfs
        - networkcfg
        - machineid
        - fstab
        - locale
        - keyboard
        - localecfg
        - luksopenswaphookcfg
        - luksbootkeyfile
        - initcpiocfg
        - initcpio
        - users
        - displaymanager
        - mhwdcfg
        - hwclock
        - services
        - bootloader
        - postcfg
        - btrfs-fix
        - umount
    - show:
        - finished   

branding: biglinux

prompt-install: true

dont-chroot: false' > /etc/calamares/settings.conf


touch /etc/calamares/biglinux

fi


# Start calamares
/usr/bin/calamares-manjaro
