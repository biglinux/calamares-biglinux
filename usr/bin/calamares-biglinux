#!/bin/bash

#Translation
export TEXTDOMAINDIR="/usr/share/locale"
export TEXTDOMAIN=calamares-settings-biglinux


if [ ! -f "/etc/calamares/biglinux" ]; then

# Simplify welcome

echo '---
showSupportUrl:         false
showKnownIssuesUrl:     false
showReleaseNotesUrl:    false

requirements:
    internetCheckUrl: http://networkcheck.kde.org
    requiredStorage:    4
    requiredRam:        0.5
    check:
      - storage
      - ram
      - power
      - internet
      - root
    required:
      - storage
      - ram
      - root
geoip:
    style:  "json"
    url:    "https://ipapi.co/json"
    selector: "country"' > /etc/calamares/modules/welcome.conf

# Force btrfs compression using zstd




sed -i 's|mount_option,|mount_option, "compress-force=zstd,space_cache=v2",|g' /usr/lib/calamares/modules/mount/main.py




sed -i 's|space_cache|usebackuproot,space_cache=v2,discard=async,autodefrag,compress-force=zstd:2,commit=10|g;s|ssd,compress=zstd,commit=120|ssd|g' /usr/share/calamares/modules/fstab.conf

# Use btrfs for default
sed -i 's|defaultFileSystemType.*"ext4"|defaultFileSystemType:  "btrfs"|g' /usr/share/calamares/modules/partition.conf


echo '
---
defaultGroups:
    - cdrom
    - floppy
    - audio
    - dip
    - video
    - plugdev
    - netdev
    - lpadmin
    - scanner
    - bluetooth
    - vboxsf
    - sambashare
    - input
    - scard
    - lp
    - network
    - power
    - sys
    - wheel
autologinGroup:  autologin
doAutologin:     false
sudoersGroup:    wheel
setRootPassword: false
doReusePassword: false
availableShells: /bin/bash, /bin/zsh
avatarFilePath:  ~/.face
userShell:       /bin/bash' > /etc/calamares/modules/users.conf



# General configuration
echo '---
modules-search: [ local ]

sequence:
    - show:
        - welcome
        - locale
        - keyboard
        - partition
        - users
        - summary
    - exec:
        - partition
        - mount
        - unpackfs
        - networkcfg
        - machineid
        - fstab
        - locale
        - keyboard
        - localecfg
        - luksopenswaphookcfg
        - luksbootkeyfile
        - initcpiocfg
        - initcpio
        - users
        - displaymanager
        - mhwdcfg
        - hwclock
        - services
        - grubcfg
        - grubcfg-fix
        - bootloader
        - postcfg
        - btrfs-fix
        - umount
    - show:
        - finished   

branding: biglinux

prompt-install: true

dont-chroot: false
oem-setup: false
disable-cancel: false
disable-cancel-during-exec: false
quit-at-end: false' > /etc/calamares/settings.conf


touch /etc/calamares/biglinux

fi

cd /usr/share/bigbashview/bcc/apps/bigbashview-calamares/
bigbashview -n $"Instalar o BigLinux" -s 1100x550 index.sh.htm

# Start calamares
/usr/bin/calamares-manjaro
