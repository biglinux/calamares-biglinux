#!/bin/bash
##################################
#  Author1: Bruno Goncalves (www.biglinux.com.br) 
#  Author2: Rafael Ruscher (rruscher@gmail.com)  
#  Date:    2022/02/28 
#  Modified:2022/08/05 
#  
#  Description: Calamares modified usage of BigLinux 
#  
# Licensed by GPL V2 or greater
##################################

#Translation
LANGUAGE=$LANG:en
export TEXTDOMAINDIR="/usr/share/locale"
export TEXTDOMAIN=calamares-biglinux

NotPossibleInstall=$"<font color='red'><b>Não é possível instalar.</b></font><br><br> "
NotPossibleRemove=$"<font color='red'><b>Não é possível remover.</b></font><br><br>"
NotPossibleLogin=$"<font color='red'><b>Não é possível encontrar Gerenciador de Login</b></font><br><br>" 
BACK_HISTORY=$"VOLTAR"
CONTINUE_HISTORY=$"AVANÇAR"
ERRO_MSG=$"ERRO!"
SUCCESS_MSG=$"SUCESSO!"

windowID="$(xprop -root '\t$0' _NET_ACTIVE_WINDOW | cut -f 2)"

# Clean
rm -f /tmp/start_calamares
rm -f /tmp/biglinux-calamares-pkg-install.err
rm -f /tmp/biglinux-calamares-pkg-remove.err

pkgProblemInstall=""
pkgProblemRemove=""
pkgProblem=""

echo "<div style='display:none;'>"
    pacman -Si $(echo $install_packages | tr -d '\r') 2> /tmp/biglinux-calamares-pkg-install.err
   
    if [ "$?" != "0" ]; then
        pkgProblemInstall="yes"
    fi
echo "</div>"

if [ "$remove_packages" != "" ]; then
    for package  in $remove_packages; do
        if [ -z "$(grep "$package" /rootfs-pkgs.txt)" ]; then
            echo $package >> /tmp/biglinux-calamares-pkg-remove.err
            pkgProblemRemove="yes"
        fi
    done
fi

if [ -e "/tmp/biglinux-calamares-pkg-install.err" ]; then
  msg_not_install="$NotPossibleInstall $(cat /tmp/biglinux-calamares-pkg-install.err | sed 's/\"/<b>/;s/\"/<\/b>/')<br><br>"
else
  msg_not_install=""
fi

if [ -e "/tmp/biglinux-calamares-pkg-remove.err" ]; then
  msg_not_remove="$NotPossibleRemove $(cat /tmp/biglinux-calamares-pkg-remove.err)<br><br>"
else
  msg_not_remove=""
fi

if [ -z "$(echo $install_packages | grep $login_manager)" ];then
  msg_not_login="$NotPossibleLogin <b>$login_manager</b><br>"
  pkgProblem="yes"
else
  msg_not_login=""
fi 

cat << EOF
<head>
  <meta charset="UTF-8">
  <title>$TITLE</title>
  <script src="/usr/share/bigbashview/bcc/materialize/js/jquery.js"></script>
  <link rel="stylesheet" href="./style.css">
</head>
EOF

# Get body tag with color light or not
/usr/share/bigbashview/bcc/shell/getbgcolor.sh

cat <<EOF
<div class="dark-light">
    <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />
    </svg>
</div>
EOF

echo '<div class=info>'
echo $"O sistema está em modo"
echo '<strong>'
[ -d /sys/firmware/efi ] && echo ' UEFI' || echo ' BIOS (Legacy)'
echo '</strong>'
echo $"e com o kernel" 
echo '<strong>'
echo "$(uname -r | cut -f1 -d-)" 
echo '</strong>'
echo '</div>'

cat << EOF
  <div class="container" style="display: grid;"> 
    <div class="panel calamares-big-table"> 
      <div class="calamares-big-plan" id=customSystem>
EOF
if ([ "$pkgProblemInstall" = "yes" ]) || ([ "$pkgProblemRemove" = "yes" ]) || ([ "$pkgProblem" = "yes" ]) then

  echo '<h3 class="calamares-big-header" style="text-transform: uppercase;">$ERRO_MSG</h3>'
  echo '<div class="p"></div>'
  echo "<pre>"
  if [ "$pkgProblemInstall" = "yes" ]; then
    echo "$msg_not_install"
  fi  
    
  if [ "$pkgProblemRemove" = "yes" ]; then
    echo "<b>$msg_not_remove</b>"
  fi  
    
  if [ "$pkgProblem" = "yes" ]; then
    echo "$msg_not_login"
  fi
  echo "</pre>"
  
else

cat << EOF
<h3 class="calamares-big-header" style="text-transform: uppercase;">$SUCCESS_MSG</h3>
<script>
  window.onload = function(){
    document.forms[0].submit();
  }
</script>
EOF

fi

echo '<form action=wait.sh.htm>'
echo '<input type="hidden" id="use_custom_desktop" name="use_custom_desktop" value="yes">'
echo "<input type=\"hidden\" id=\"option\" name=\"option\" value=\"$option\">"
echo "<input type=\"hidden\" id=\"install_packages\" name=\"install_packages\" value=\"$install_packages\">"
echo "<input type=\"hidden\" id=\"remove_packages\" name=\"remove_packages\" value=\"$remove_packages\">"
echo "<input type=\"hidden\" id=\"login_manager\" name=\"login_manager\" value=\"$login_manager\">"

if ([ "$pkgProblemInstall" = "yes" ]) || ([ "$pkgProblemRemove" = "yes" ]) || ([ "$pkgProblem" = "yes" ]) then
  echo '<a href="#" onclick="window.history.go(-1);" class="calamares-big-button is-featured">$BACK_HISTORY</a>'
else
  echo '<a href="#" onclick="document.forms[0].submit()" class="calamares-big-button is-featured">$CONTINUE_HISTORY</a>'
fi

cat << EOF
      </div>
    </div>
  </div>
  <div class="logo">
      <img id="btn-big" src="logo.svg" class="logo-biglinux">
  </div>
<script  src="./script.js"></script>
</body>
</html>
EOF
